name: Generate Social Content

on:
  push:
    paths:
      - 'content/posts/**/*.mdx'
    branches:
      - main

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      post:
        description: 'Specific post to generate (e.g., invest/nebius-ai-infrastructure)'
        required: false
      all:
        description: 'Generate for all posts'
        type: boolean
        default: false

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need to compare with previous commit

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed MDX files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.all }}" = "true" ]; then
              echo "mode=all" >> $GITHUB_OUTPUT
            elif [ -n "${{ github.event.inputs.post }}" ]; then
              echo "mode=post" >> $GITHUB_OUTPUT
              echo "post=${{ github.event.inputs.post }}" >> $GITHUB_OUTPUT
            else
              echo "mode=recent" >> $GITHUB_OUTPUT
            fi
          else
            # Get list of changed MDX files in content/posts
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'content/posts/**/*.mdx' | head -10)
            if [ -n "$CHANGED" ]; then
              echo "mode=changed" >> $GITHUB_OUTPUT
              echo "files<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGED" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "mode=none" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate social content
        if: steps.changed-files.outputs.mode != 'none'
        run: |
          MODE="${{ steps.changed-files.outputs.mode }}"

          if [ "$MODE" = "all" ]; then
            node scripts/generate-social.js --all
          elif [ "$MODE" = "post" ]; then
            node scripts/generate-social.js --post "${{ steps.changed-files.outputs.post }}"
          elif [ "$MODE" = "recent" ]; then
            node scripts/generate-social.js --recent
          elif [ "$MODE" = "changed" ]; then
            # Process each changed file
            echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
              if [ -n "$file" ]; then
                # Extract relative path from content/posts/
                POST_PATH=$(echo "$file" | sed 's|content/posts/||' | sed 's|\.mdx$||')
                echo "Processing: $POST_PATH"
                node scripts/generate-social.js --post "$POST_PATH"
              fi
            done
          fi

      - name: Commit generated content
        if: steps.changed-files.outputs.mode != 'none'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Check if there are changes to commit
          if git diff --quiet content/social/; then
            echo "No social content changes to commit"
          else
            git add content/social/
            git commit -m "Generate social content for new posts

            Auto-generated by GitHub Actions"
            git push
          fi
