---
import BaseLayout from './BaseLayout.astro';
import { getReadingTime } from '../utils/reading-time';
import { detectFAQs, detectHowTo, generateFAQSchema, generateHowToSchema } from '../utils/schema-detection';

interface Props {
  title: string;
  description: string;
  pillar: 'build' | 'invest' | 'thrive';
  publishedAt: string;
  topics?: string[];
  content?: string;
  keywords?: string[];
  updatedAt?: string;
  coverImage?: string;
  slug?: string;
}

const {
  title,
  description,
  pillar,
  publishedAt,
  topics = [],
  content,
  keywords,
  updatedAt,
  coverImage,
  slug,
} = Astro.props;

// Compute reading time from raw content
const reading = content ? getReadingTime(content) : null;

// Detect structured content schemas
const additionalSchemas: object[] = [];
if (content) {
  const faqs = detectFAQs(content);
  if (faqs) additionalSchemas.push(generateFAQSchema(faqs));

  const steps = detectHowTo(content);
  if (steps) additionalSchemas.push(generateHowToSchema(steps, title));
}

const dateFormatted = new Date(publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout
  title={title}
  description={description}
  ogType="article"
  publishedAt={publishedAt}
  updatedAt={updatedAt}
  pillar={pillar}
  ogImage={coverImage}
  keywords={keywords}
  wordCount={reading?.wordCount}
  readingTime={reading?.duration}
  readingMinutes={reading?.minutes}
  slug={slug}
  additionalSchemas={additionalSchemas}
>
  <article>
    <header class="mb-10">
      <div class="flex items-center gap-3 mb-4">
        <a href={`/${pillar}`} class={`pillar-tag pillar-tag--${pillar} no-underline`}>
          {pillar}
        </a>
        <span
          class="text-sm font-[family-name:var(--font-label)]"
          style="color: var(--color-ink-muted);"
        >
          {dateFormatted}
        </span>
        {reading && (
          <span
            class="text-sm font-[family-name:var(--font-label)]"
            style="color: var(--color-ink-muted);"
          >
            &middot; {reading.minutes} min read
          </span>
        )}
      </div>
      <h1 class="text-4xl md:text-5xl mb-3" style="font-family: var(--font-heading);">
        {title}
      </h1>
      <p style="color: var(--color-ink-light); font-size: 1.1rem;">
        {description}
      </p>
      {topics.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {topics.map((topic) => (
            <span
              class="text-xs px-2 py-0.5 font-[family-name:var(--font-label)]"
              style="background: var(--color-parchment-dark); color: var(--color-ink-muted);"
            >
              {topic}
            </span>
          ))}
        </div>
      )}
    </header>
    <div class="prose">
      <slot />
    </div>
  </article>
</BaseLayout>
