---
import { getCollection } from 'astro:content';
import { createReader } from '@keystatic/core/reader';
import keystaticConfig from '../../keystatic.config';
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import PostCard from '../components/PostCard.astro';
import PillarSection from '../components/PillarSection.astro';

const reader = createReader(process.cwd(), keystaticConfig);
const homepage = await reader.singletons.homepage.read();

const buildPosts = await getCollection('build');
const investPosts = await getCollection('invest');
const thrivePosts = await getCollection('thrive');

const allPosts = [...buildPosts, ...investPosts, ...thrivePosts]
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime());

// Group recent posts by year
const postsByYear = allPosts.reduce<Record<string, typeof allPosts>>((acc, post) => {
  const year = new Date(post.data.publishedAt).getFullYear().toString();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {});

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));

function toPost(entry: typeof allPosts[number]) {
  return {
    title: entry.data.title,
    slug: entry.data.slug,
    pillar: entry.data.pillar,
    publishedAt: entry.data.publishedAt.toISOString(),
  };
}
---

<BaseLayout title="Home">
  <Hero
    headline={homepage?.heroHeadline}
    text={homepage?.heroText}
    principles={homepage?.heroPrinciples}
  />

  <!-- Recent posts -->
  <section class="mb-12">
    <h2
      class="text-xl mb-5 pb-2 border-b-[2.5px]"
      style="font-family: var(--font-heading); border-color: var(--color-border);"
    >
      Recent
    </h2>
    {years.map((year) => (
      <div class="mb-5">
        <h3
          class="text-xs font-[family-name:var(--font-mono)] mb-2"
          style="color: var(--color-ink-muted);"
        >
          {year}
        </h3>
        <ul class="list-none m-0 p-0">
          {postsByYear[year].map((post) => (
            <PostCard
              title={post.data.title}
              href={`/${post.data.pillar}/${post.data.slug}`}
              pillar={post.data.pillar}
              publishedAt={post.data.publishedAt.toISOString()}
            />
          ))}
        </ul>
      </div>
    ))}
  </section>

  <!-- Pillar sections -->
  <div
    class="pt-10 border-t-[2.5px]"
    style="border-color: var(--color-border-light);"
  >
    <PillarSection
      pillar="build"
      description={homepage?.buildDescription || "Startups, products, and the craft of creation"}
      posts={buildPosts.map(toPost)}
    />
    <PillarSection
      pillar="invest"
      description={homepage?.investDescription || "Markets, money, and long-term wealth"}
      posts={investPosts.map(toPost)}
    />
    <PillarSection
      pillar="thrive"
      description={homepage?.thriveDescription || "Health, energy, and sustainable performance"}
      posts={thrivePosts.map(toPost)}
    />
  </div>
</BaseLayout>
